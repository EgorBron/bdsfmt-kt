---
created: 2022-06-13T00:00:00
title: "SyrDB Protocol 0.2 Prototype"
author: "The Singularity¹"
project:
    type: document
    id: "SG/SDB:P@0.2$prototype"
    documentData:
        codeName: "Funcking binary hell"
---

# Прототип SyrDB Protocol 0.2
> **Примичание.** <br>
> `C` - это Клиент<br>
> `S` - это Сервер

## 1. Формат запроса и ответа
### **1.1.** Запрос
#### **1.1.1.** UTF-8 представление
```py
SyrDB/0.2 <код операции>
{<заголовок>} <значение заголовка>
...

<контент>
```

Значение          | Тип      | Обязательно?    | Описание
----------------- | -------- | --------------- | ------------------------------
`1.` Код операции | `Число`  | Да              | Числовое обозначение операции.
`2.` Заголовок    | `Строка` | Зависит от `OP` | Название заголовка.
`3.` Значение 2.  | —        | Зависит от `OP` | Значение заголовка. 
`4.` Контент      | —        | Зависит от `OP` | Содержимое запроса. 

#### **1.1.2.** Бинарное представление
#### **1.1.2.1.** Патерн
```py
Request {
    Headers Length (8),
    Content Length (8),
    Flags Length (8),
   
    OP (2),

    Headers (?),
    Content (?),
    Flags (?)
}
```

Значение            | Тип          | Описание
------------------- | ------------ | -------------------------
`1.` Headers Length | `Число`      | Длина заголовков запроса
`2.` Content Length | `Число`      | Длина содержимого запроса
`3.` Flags Length   | `Число`      | Длина флагов запроса
`4.` OP             | `Число`      | Код операции
`6.` Headers        | `Заголовки`  | Заголовки запроса
`7.` Content        | `Содержимое` | Содержимое запроса
`8.` Flags          | `Флаги`      | Флаги запроса (макс. `7`)

### **1.2.** Ответ
#### **1.2.1.** UTF-8 представление
```py
SyrDB/0.2 <код ответа>
{<заголовок>} <значение заголовка>
...

<контент>
```

Значение         | Тип      | Обязательно?    | Описание
---------------- | -------- | --------------- | ------------------------------
`1.` Код ответа  | `Число`  | Да              | Числовое обозначение ответа.
`2.` Заголовок   | `Строка` | Зависит от `OP` | Название заголовка.
`3.` Значение 2. |          | Зависит от `OP` | Значение заголовка. 
`4.` Контент     |          | Зависит от `OP` | Содержимое запроса. 

#### **1.2.2.** Бинарное представление
#### **1.2.2.1.** Патерн
```py
Response {
    Headers Length (8),
    Content Length (8),

    Status Code (2),

    Headers (?), 
    Content (?)
}
```

Значение            | Тип          | Описание
------------------- | ------------ | ----------------------------------
`1.` Headers Length | `Число`      | Длина заголовков.
`2.` Content Length | `Число`      | Длина содержимого.
`3.` Flags Length   | `Число`      | Длина флагов.
`4.` Status Code    | `Число`      | Числовое обозначение кода статуса.
`6.` Headers        | `Заголовки`  | Заголовки запроса.
`7.` Content        | `Содержимое` | Содержимое запроса.
`8.` Flags          | `Флаги`      | Флаги ответа. (макс. `7`)

### **1.3.** Флаги, Заголовки и Коды операций/ответов
#### **1.3.1.** Типы флагов
Байт  | Тип                   | Описание                      | Условие
----- | --------------------- | ----------------------------- | ------------
`0x1` | `Логическое значение` | Расписывать ошибку полностью? | *Нет*
`0x2` | `Число`               | Максимальная длина ответа     | `2⁹-1<N<2¹⁶`

**Форматы условий**
```py
# Число
SM = Наименьшое число
N = Указаное число
BN = наибольшое число
SM<N<BN

В числах поддерживаются степени (Nⁿ).
```

#### **1.3.2.** Типы заголовков
Байт  | Строка    | Тип    | З / О
----- | --------- | ------ | --------------
`0x1` | Провайдер | JSON   | Запрос
`0x2` | Версия    | Строка | Запрос и Ответ
`0x3` | Описание  | Строка | Ответ

#### **1.3.3.** Коды операций
**1.3.3.1.** *Группы операций (1ый байт)*
Байт  | Группа
----- | -------------------
`0x0` | `A` (*Авторизация*)
`0x1` | `I¹` (*Информация*)
`0x2` | `D` (*Базы данных*)
`0x3` | `C` (*Колекции*)
`0x4` | `I²` (*Предметы*)

**1.3.3.2.** *Операции (2ой байт)*
Байт, Группа | Название
------------ | --------------------------------
`0x0`, `A`   | **Авторизоваться**
`0x1`, `I¹`  | **Информация о сервере**
`0x2`, `I¹`  | **Состояние сервера**
`0x1`, `D`   | **Список баз данных**
`0x2`, `D`   | **Создать базу данных**
`0x3`, `D`   | **Удалить базу данных**
`0x4`, `D`   | **Информация о базе данных**
`0x1`, `C`   | **Список колекций**
`0x2`, `C`   | **Создать колекцию**
`0x3`, `C`   | **Удалить колекцию**
`0x1`, `I²`  | **Внести предмет в колекцию**
`0x2`, `I²`  | **Удалить предмет из колекции**
`0x3`, `I²`  | **Удалить предметы из колекции**
`0x4`, `I²`  | **Обновить предмет в колекции**
`0x5`, `I²`  | **Обновить предметы в колекции**
`0x6`, `I²`  | **Найти предмет в колекции**
`0x7`, `I²`  | **Найти предметы в колекции**

**1.3.3.3.** *Пример (`Python`)*
> **Код:**
```py
bytelist = b'\x01\x01'
op_group = bytelist[0] # 1 = I¹ = Информация
op_code = bytelist[1] # I¹ + 1 = Информация о сервере

print(op_group, op_code)
```
> **Результат:**
```py
1 1
```

#### **1.3.4.** Коды ответов
**1.3.4.1.** *Группы ответов (1ый байт)*
Байт  | Группа
----- | ----------------------------
`0x1` | `S` (*Успешно*)
`0x2` | `E¹` (*Ошибка пользователя*)
`0x3` | `E²` (*Ошибка сервера*)

**1.3.4.2.** *Ответы (2ой байт)*
Байт, Группа | Название
------------ | -----------------------------------------
`0x1`, `S`   | **Операция выполнена!**
`0x2`, `S`   | **Авторизация выполнена!**
`0x1`, `E¹`  | **Требуется авторизация**
`0x2`, `E¹`  | **<заголовок / ключ> не указан**
`0x3`, `E¹`  | **<заголовок / ключ> не верен**
`0x4`, `E¹`  | **Недостаточно параметров**
`0x5`, `E¹`  | **У вас недостаточно прав**
`0x6`, `E¹`  | **Неизвестная операция**
`0x1`, `E²`  | **Сервер не смог обработать этот запрос**
`0x2`, `E²`  | **Версия SyrDB Protocol не поддерживается**
`0x3`, `E²`  | **Неизвестная ошибка**

**1.3.4.3.** *Пример (`Python`)*
> **Код:**
```py
bytelist = b'\x01\x01'
status_group = bytelist[0] # 1 = S = Успешно
status_code = bytelist[1] # S + 1 = Операция выполнена!

print(status_group, status_code)
```
> **Результат:**
```py
1 1
```

### **1.1.4.** Типы
#### **1.1.4.1.** Число
Значения числового типа имеют ограничение `-1<N<2²⁵⁶-1`, где `N` = указаному числовому значению

**Пример шифровки (`Python`)**
> **Код:**
```py
bytelist = (189).to_bytes(32, 'big')
print(bytelist)
```
> **Результат:**
```py
b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xbd'
```

**Пример дещифровки (`Python`)**
> **Код:**
```py
bytelist = b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xbd' # 189
print(int.from_bytes(bytelist, "big"))
```
> **Результат:**
```py
189
```

#### **1.1.4.2.** Флаги
Значения флагового типа состоят из байтовых строк:
```py
Flag {
    Name (1),
    Value (47)
}
```

**Значения:**
- *Name* (`Число`) - Название (ID) флага (См. **1.3.1.**)
- *Value* (`Число` **ИЛИ** `Логическое значение`) - Значение флага

**Пример (`Python`)**
> **Код:**
```py
flag = b'\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
ftype = flag[0] # 1, Нужно ли серверу подробно расписывать ошибки
fvalue = sum(list(flag[1:48])) # 1, Да

print(ftype, fvalue)
```
> **Результат:**
```py
1 1
```

#### **1.1.4.3.** Строка
Строки состоят из бинарных строк.

#### **1.1.4.4.** Логическое значение
Логические значения состоят из 1 байта, значение которого должно быть `0` **ИЛИ** `1`.
```py
0 = True
1 = False
```

**Дополнение к 1.1.4.4.** *Пример*
> **Код:**
```py
bytelist = b'\x01'
value = bytelist[0] == 1 # True - Да

print(value)
```
> **Результат:**
```py
True
```

#### **1.1.4.5.** Заголовки
Заголовки состоят из названия, длины значения и самого значения.
```py
Header {
    Name (1),
    Type (1),
    Length (6),
    Value (?)
}
```

Значение | Тип     | Описание
-------- | ------- | -----------------------------------------
Name     | `Число` | Название (ID) заголовка (См. **1.3.2.**).
Type     | `Число` | Тип значения, типы расписаны ниже.
Length   | `Число` | Длина значения заголовка.
Value    |         | Значение заголовка.

**Типы:**
Байт  | Тип
----- | -----------------------
`0x0` | **Число**
`0x1` | **Строка**
`0x2` | **Логическое значение**
`0x3` | **JSON**

#### **1.1.4.6.** JSON
JSON хранится так же как и строка.

#### **1.1.4.7.** Содержимое
Содержимое записывается с следующим бинарным патерном:
```py
Content {
    Type (1),
    Value (?)
}
```

Значение | Тип     | Описание
-------- | ------- | ----------------------------------
Type     | `Число` | Тип значения, типы расписаны ниже.
Value    |         | Значение содержимого.

**Типы:**
Байт  | Тип
----- | -----------------------
`0x0` | **Число**
`0x1` | **Строка**
`0x2` | **Логическое значение**
`0x3` | **JSON**

## 2. Использование БД
### 2.1. Подключение клиента к БД
Прежде чем использовать БД, клиент должен авторизоваться в ней, дав запрос с кодом операции `0x00`:
```py
C: [op=0x00, ...] -> S # C sends a 0 request
C <- [..., status_code=0x12] :S # S sends a response
...
```
Теперь клиент авторизован и может использовать БД.

### 2.2. Создание БД и колекции
Теперь нам стоит создать базу данных, а вней колекцию для хронения данных. Мы создадим БД и колекцию с названием `test`. Делается это двумя запросами (Кстати, можно дать два запроса одновремено, но в примере будут показаны поочерёдные запросы):
```py
...
C: [op=0x22, content={"name": "test"}] -> S # C sends a D/2 request
C <- [..., status_code=0x11] :S # S sends a S/1 response
C: [op=0x32, content={"db": "test", "name": "test"}] # C sends a C/2 request
C <- [..., status_code=0x11] :S # S sends a S/1 response
...
```
Отлично, теперь у нас есть место, где можно хранить данные.

### 2.3. Занесение ифнормации в колекцию
Теперь давайте мы занесём информацию (предмет) в созданую нами колекцию.
```py
...
C: [op=0x41, content={"db": "test", "coll": "test", "data": {...}}] -> S # C sends a I²/1 request
C <- [..., status_code=0x11] :S # S sends a S/1 response
```
Отлично, данные занесены.